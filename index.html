<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local AI Chatbot</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-3g0YpQ6YJY2Z2+fN7WQG6xQ6jv6E8H9qzD3+9q0Gg6l5k7UQf5hFZB5P7k2nWm3K" crossorigin="anonymous">

  <style>
    body { background: #f3f6fb; }
    .chat-card { max-width: 900px; margin: 40px auto; border-radius: 12px; box-shadow: 0 6px 20px rgba(21,34,56,0.08); }
    .chat-window { height: 60vh; overflow-y: auto; padding: 18px; background: #fff; border-radius: 8px; border: 1px solid #e9eef6; }
    .message { display: inline-block; padding: 10px 14px; margin: 8px 0; border-radius: 18px; max-width: 78%; word-wrap: break-word; }
    .message.user { background: #0d6efd1a; color: #04224a; align-self: flex-end; margin-left: auto; }
    .message.bot  { background: #f1f5ff; color: #0b254f; margin-right: auto; }
    .meta { font-size: 0.78rem; color: #6c757d; margin-bottom: 6px; }
    .chat-row { display: flex; gap: 12px; align-items: flex-end; }
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: .15em; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card chat-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="card-title mb-0">Local AI Chatbot</h4>
          <div class="text-end">
            <small class="text-muted">Model: <span id="model-name">DialoGPT-small (local)</span></small>
          </div>
        </div>

        <div id="chat-window" class="chat-window d-flex flex-column"></div>

        <form id="chat-form" class="mt-3" autocomplete="off">
          <div class="input-group">
            <input id="message" type="text" class="form-control" placeholder="Type your message..." aria-label="Message" />
            <button id="send-btn" class="btn btn-primary" type="submit">
              <span id="send-text">Send</span>
              <span id="send-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
            <button id="reset-btn" type="button" class="btn btn-outline-secondary ms-2" title="Reset session">Reset</button>
          </div>
        </form>

        <div class="mt-2 text-muted small">
          This runs locally â€” model weights may download on first run. Keep the Flask server running.
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS (bundle for Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-9ndCyUaT9lT1q5o1Z+6q7bU7K7m9r1n2g1d6xEo8fGdE3i0oW0X6tv6xL0kKZ9k6"
          crossorigin="anonymous"></script>

  <!-- Inline JS: chat logic -->
  <script>
    (function () {
      const chatWindow = document.getElementById('chat-window');
      const form = document.getElementById('chat-form');
      const msgInput = document.getElementById('message');
      const sendBtn = document.getElementById('send-btn');
      const sendSpinner = document.getElementById('send-spinner');
      const sendText = document.getElementById('send-text');
      const resetBtn = document.getElementById('reset-btn');

      // Per-tab session id
      const sessionId = 'session_' + Math.random().toString(36).slice(2, 9);

      // Utility: append message element
      function appendMessage(speaker, text, meta = '') {
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column';
        if (speaker === 'user') wrapper.classList.add('align-self-end');
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.innerText = meta || (speaker === 'user' ? 'You' : 'Bot');
        const msg = document.createElement('div');
        msg.className = 'message ' + (speaker === 'user' ? 'user' : 'bot');
        msg.innerText = text;
        wrapper.appendChild(metaDiv);
        wrapper.appendChild(msg);
        chatWindow.appendChild(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return wrapper;
      }

      // Show a temporary typing indicator message (returned element)
      function showTyping() {
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column';
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.innerText = 'Bot';
        const typing = document.createElement('div');
        typing.className = 'message bot';
        typing.innerHTML = '<div class="d-flex align-items-center gap-2"><div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div><span>Thinkingâ€¦</span></div>';
        wrapper.appendChild(metaDiv);
        wrapper.appendChild(typing);
        chatWindow.appendChild(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return wrapper;
      }

      // POST to backend API
      async function sendMessageToServer(text) {
        const payload = { message: text, session_id: sessionId };
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({}));
          const msg = errData && errData.error ? errData.error : `HTTP ${resp.status}`;
          throw new Error(msg);
        }
        return resp.json();
      }

      // Form submit handler
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = msgInput.value.trim();
        if (!text) return;
        // append user message
        appendMessage('user', text, 'You');
        msgInput.value = '';
        msgInput.disabled = true;
        sendBtn.disabled = true;
        sendSpinner.classList.remove('d-none');
        sendText.classList.add('d-none');

        // show typing placeholder
        const typingElem = showTyping();

        try {
          const data = await sendMessageToServer(text);
          // remove typing element
          typingElem.remove();

          if (data.reply) {
            appendMessage('bot', data.reply, 'Bot');
          } else if (data.error) {
            appendMessage('bot', 'Error: ' + data.error, 'Bot (error)');
          } else {
            appendMessage('bot', 'No reply from server', 'Bot (warning)');
          }
        } catch (err) {
          typingElem.remove();
          appendMessage('bot', 'Network / Server error: ' + err.message, 'Bot (error)');
          console.error('Chat error:', err);
        } finally {
          msgInput.disabled = false;
          sendBtn.disabled = false;
          sendSpinner.classList.add('d-none');
          sendText.classList.remove('d-none');
          msgInput.focus();
        }
      });

      // Reset session (clears client history and asks server to reset model state)
      resetBtn.addEventListener('click', async () => {
        // Clear UI
        chatWindow.innerHTML = '';
        // Try to call a reset endpoint if available (fallback: just clear client)
        try {
          await fetch('/api/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
          }).catch(() => {});
        } catch (err) {
          // ignore
        }
        appendMessage('bot', 'Session reset. Say hi ðŸ‘‹', 'Bot');
      });

      // Add a starter greeting
      appendMessage('bot', 'Hello â€” I am a local chatbot. Ask me something!', 'Bot');
      msgInput.focus();
    })();
  </script>
</body>
</html>

